{% load i18n %}
{% load humanize %}

<!doctype html>
<html>
    <head>

        <title>[s04] NG Exile</title>

        <link rel="shortcut icon" href="/static/favicon.png">

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="/static/s04/styles.css?v=0" type="text/css" rel="stylesheet" media="all" />

        <script type="text/javascript" src="/static/js/vendor-fontawesome.js"></script>

    </head>
    <body>
        
        <div id="app" class="w-100 h-100 d-flex align-items-stretch">

            <div id="sidebar" class="h-100 bg-gray-800 border-end d-flex flex-column" :class="{ 'open':sidebarOpen }">

                <header class="h-3 flex-shrink-0 px-2 d-flex gap-2 align-items-center justify-content-center">

                    <img src="/static/favicon.png" width="24" height="24" />
                    <span class="flex-1 fs-5 text-white">NG Exile</span>
                    <span class="badge text-bg-secondary">s04</span>
                    
                    <button class="ms-auto d-md-none btn btn-secondary" type="button" @click="closeSidebar();">
                        <i class="fas fa-fw fa-times"></i>
                    </button>

                </header>

                <aside class="py-2 flex-grow-1 overflow-y-auto">

                    <div class="p-2 d-flex flex-column gap-1">

                        <div class="dropdown">

                            <button class="w-100 btn btn-secondary" type="button" data-bs-toggle="dropdown">
                                <img src="/static/s04/icons/credit.png" width="16" height="16" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'Crédit' %}" />
                                <span class="text-white">{{ profile.credit_count|intcomma }}</span>
                            </button>

                            <div class="w-100 dropdown-menu">
                                <div class="d-flex flex-column gap-2">

                                    <div class="d-flex gap-2 align-items-center">
                                        <img src="/static/s04/icons/credit.png" width="16" height="16" />
                                        <span class="text-white">{% translate 'Crédit' %}</span>
                                    </div>

                                    <div class="d-flex flex-column gap-1">

                                        <div class="d-flex gap-2 align-items-center justify-content-between">
                                            <span class="text-gray-300">{% translate 'Stock'  %}</span>
                                            <span class="text-white">{{ profile.credit_count|intcomma }}</span>
                                        </div>

                                        <div class="d-flex gap-2 align-items-center justify-content-between">
                                            <span class="text-gray-300">{% translate 'Production'  %}</span>
                                            <span class="text-white">+{{ profile.credit_prod|intcomma }} /s</span>
                                        </div>

									</div>

                                    <span class="small text-gray-400">{% translate 'Les crédits sont utilisés pour rechercher de nouveaux vaisseaux, pour rechercher des améliorations et des technologies plus avancées. Les crédits sont produits par les Raffineries de vos planètes.'  %}</span>

								</div>
                            </div>

                        </div>

                        <div class="dropdown">

                            <button class="w-100 btn btn-secondary" type="button" data-bs-toggle="dropdown">
                                <img src="/static/s04/icons/prestige.png" width="16" height="16" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="{% translate 'Prestige' %}" />
                                <span class="text-white">{{ profile.prestige_count|intcomma }}</span>
                            </button>

                            <div class="w-100 dropdown-menu">
                                <div class="d-flex flex-column gap-2">

                                    <div class="d-flex gap-2 align-items-center">
                                        <img src="/static/s04/icons/prestige.png" width="16" height="16" />
                                        <span class="text-white">{% translate 'Prestige' %}</span>
                                    </div>

                                    <div class="d-flex gap-2 align-items-center justify-content-between">
                                        <span class="text-gray-300">{% translate 'Stock'  %}</span>
                                        <span class="text-white">{{ profile.prestige_count|intcomma }}</span>
                                    </div>

                                    <span class="small text-gray-400">{% translate 'Le Prestige est utilisé pour rechercher de nouveaux vaisseaux, pour rechercher des améliorations et des technologies plus avancées. Le prestige s\'obtient en participant à des combats de flotte.'  %}</span>

								</div>
                            </div>

                        </div>

                    </div>

                    <div class="p-2">
                        <div class="nav flex-column">

                            <div class="nav-item">
                                <a class="nav-link {% if selectedMenu == 'planet' %}active{% endif %}" href="/s04/planet-buildings/">
                                    <i class="fas fa-fw fa-globe"></i>
                                    <span>{% translate 'Planète'  %}</span>
                                    <span class="ms-auto badge text-bg-secondary">{{ current_planet.galaxy }}.{{ current_planet.sector }}.{{ current_planet.number }}</span>
                                </a>
                            </div>

                        </div>
                    </div>

                </aside>

                <footer class="h-3 flex-shrink-0 border-top d-flex gap-2 align-items-center justify-content-around">

                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                        <input type="hidden" name="cmd" value="_s-xclick">
                        <input type="hidden" name="hosted_button_id" value="7XYD7SJFKQ8M4">
                        <button type="submit" class="p-0 border-0 bg-transparent" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Faîtes un don via Paypal">
                            <img src="/static/img/interface/paypal.png" width="24" height="24" />
                        </button>
                    </form>

                    <a href="https://ko-fi.com/freddecgames" target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Offrez-moi un Ko-fi">
                        <img src="/static/img/interface/kofi.png" width="24" height="24" />
                    </a>

                    <a href="https://www.patreon.com/bePatron?u=61283131" target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Devenez un supporteur Patreon">
                        <img src="/static/img/interface/patreon.png" width="24" height="24" />
                    </a>

                    <a href="https://discord.gg/3UkgeeT9CV" target="_blank" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Rejoignez notre serveur Discord">
                        <img src="/static/img/interface/discord.png" width="24" height="24" />
                    </a>
                    
                </footer>

            </div>

            <div id="content" class="h-100 d-flex flex-column">

                <header class="h-3 border-bottom flex-shrink-0 bg-gray-800 d-flex align-items-center">
                    <div class="px-2 container d-flex gap-2 align-items-center">
                        
                        <button class="d-md-none btn btn-secondary" type="button" @click="openSidebar();">
                            <i class="fas fa-fw fa-bars"></i>
                        </button>

                        {% block header %}{% endblock %}

                    </div>
                </header>

                <div class="flex-grow-1 overflow-y-auto">
                    <div class="container px-0 py-2">
                        {% block content %}{% endblock %}
                    </div>
                </div>

            </div>

        </div>

        <script async src="https://www.googletagmanager.com/gtag/js?id=G-212X2QX8W5"></script>
        <script>
            window.dataLayer = window.dataLayer || []
            function gtag(){ dataLayer.push(arguments) }
            gtag('js', new Date())
            gtag('config', 'G-212X2QX8W5')
        </script>

        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>        
        <script>
            const { createApp, h } = Vue

            const app = createApp({

                data() {
                    return {

                        sidebarOpen: false,
                    }
                },

                methods: {

                    openSidebar() { this.sidebarOpen = true },
                    closeSidebar() { this.sidebarOpen = false },
                },
            })
            
            app.component(
                'Countdown', {

                props: {

                    seconds: { type: Number, default: 0 },
                },

                data() {
                    return {

                        counting: false,
                        endTime: 0,
                        requestId: 0,
                        remainingTime: 0,
                    }
                },

                watch: {
                    $props: {

                        deep: true,
                        immediate: true,

                        handler() {

                            this.remainingTime = (this.seconds * 1000)
                            this.endTime = new Date().getTime() + (this.seconds * 1000)

                            this.start()
                        },
                    },
                },

                methods: {
                    
                    start() {

                        if (this.counting) return
                        this.counting = true

                        if (document.visibilityState === 'visible') this.continue()
                    },

                    continue() {

                        if (!this.counting) return

                        const delay = Math.min(this.remainingTime, 500)
                        if (delay > 0) {
                            
                            let init
                            let prev

                            const step = (now) => {

                                if (!init) init = now
                                if (!prev) prev = init

                                const range = now - init
                                if (range >= delay || range + ((now - prev) / 2) >= delay) {

                                    this.progress()
                                }
                                else {

                                    this.requestId = requestAnimationFrame(step)
                                }
                            }

                            this.requestId = requestAnimationFrame(step)
                        }
                        else {

                            this.end()
                        }
                    },

                    progress() {

                        if (!this.counting) return

                        this.update()
                        this.continue()
                    },

                    update() {

                        if (this.counting) {

                            this.remainingTime = Math.max(0, this.endTime - new Date().getTime())
                        }
                    },

                    pause() {

                        cancelAnimationFrame(this.requestId)
                    },

                    end() {

                        if (!this.counting) return

                        this.pause()

                        this.counting = false
                        this.remainingTime = 0
                    },

                    handleVisibilityChange() {
                        switch (document.visibilityState) {

                            case 'visible':
                                this.update()
                                this.continue()
                                break

                            case 'hidden':
                                this.pause()
                                break

                            default:
                        }
                    },
                },

                computed: {

                    formatTime() {

                        let s = this.remainingTime / 1000

                        let d = Math.floor(s / (3600 * 24))

                        let h = Math.floor(s / 3600) % 24
                        if (h < 10) h = '0' + h

                        let m = Math.floor(s / 60) % 60
                        if (m < 10) m = '0' + m

                        s = Math.floor(s % 60)
                        if (s < 10) s = '0' + s

                        if (d > 0) return d + 'j' + ' ' + h + ':' + m + ':' + s
                        else return h + ':' + m + ':' + s
                    },
                },

                mounted() {

                    document.addEventListener('visibilitychange', this.handleVisibilityChange)
                },

                beforeUnmount() {

                    document.removeEventListener('visibilitychange', this.handleVisibilityChange)
                    this.pause()
                },

                render() {
                    
                    let s = this.remainingTime / 1000

                    if (s <= 0) return h('span', { class:'text-primary-400' }, 'Terminé')
                    else if (s <= 600) return h('span', { class:'text-green-400' }, this.formatTime)
                    else return h('span', { class:'text-yellow-300' }, this.formatTime)
                },
            })

            app.mount('#app')

        </script>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script>
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        </script>

    </body>
</html>
