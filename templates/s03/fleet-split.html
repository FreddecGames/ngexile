{% extends "s03/layout.html" %}
{% load humanize %}
{% block content %}
    <script>
        function getval(objname) {
        
            var obj = document.getElementsByName(objname);
            if(obj == null || obj[0] == null) return 0;
            var s = parseInt(obj[0].value, 10);
            if (isNaN(s)) return 0; else return s;
        }
        
        function setval(objname, val){ document.getElementsByName(objname)[0].value = val; }

        var resources = new Array("ore", "hydrocarbon", "scientists", "soldiers", "workers");

        function updateresources() {
        
            var rOrig = {{fleet_load}};
            var rNew = 0;

            for( i = 0; i < resources.length; i++) {
            
                rNew += getval("load_" + resources[i]);
                rOrig -= getval("load_" + resources[i]);
            }

            if (rOrig > parseInt(document.getElementById("capacityOrig").innerHTML) || rOrig < 0)
                rOrig = '<span class="text-danger">' + rOrig + '</span>';
                
            if (rNew > parseInt(document.getElementById("capacityNew").innerHTML) || rNew < 0)
                rNew = '<span class="text-danger">' + rNew + '</span>';

            document.getElementById("loadOrig").innerHTML = rOrig;
            document.getElementById("loadNew").innerHTML = rNew;
            
            window.setTimeout("updateresources()", 200);
        }

        function setmaximum(res, res_max) {
        
            var maxload = parseInt(document.getElementById("capacityNew").innerHTML);

            for (i = 0; i < resources.length; i++) {
                if (resources[i] != res)
                    maxload -= getval("load_" + resources[i]);
            }

            if (maxload > res_max) maxload = res_max;
            else if (maxload < 0) maxload = 0;

            document.getElementsByName("load_" + res)[0].value = maxload;
        }

        function transfer_all() {
        
            setmaximum('ore', {{available_ore}});
            setmaximum('hydrocarbon', {{available_hydrocarbon}});
            setmaximum('scientists', {{available_scientists}});
            setmaximum('soldiers', {{available_soldiers}});
            setmaximum('workers', {{available_workers}});
        }

        var ships = new Array();

        function updatecargo() {
        
            var cargoOrig = 0;
            var cargoNew = 0;

            for (i = 0; i < ships.length; i++) {
            
                cargoOrig = cargoOrig + ships[i][1] * ships[i][2] - Math.min(getval("transfership" + ships[i][0]), ships[i][2]) * ships[i][1];
                cargoNew = cargoNew + Math.min(getval("transfership" + ships[i][0]), ships[i][2]) * ships[i][1];
            }

            var obj = document.getElementById("capacityOrig");
            if (obj.innerHTML != cargoOrig) obj.innerHTML = cargoOrig;
            
            obj = document.getElementById("capacityOrig2");
            if (obj.innerHTML != cargoOrig) obj.innerHTML = cargoOrig;

            obj = document.getElementById("capacityNew");
            if (obj.innerHTML != cargoOrig) obj.innerHTML = cargoNew;

            obj = document.getElementById("capacityNew2");
            if (obj.innerHTML != cargoOrig) obj.innerHTML = cargoNew;

            window.setTimeout("updatecargo()", 200);
        }

        function submitchanges() {

            var nbShipsOrig = 0;
            var nbShipsNew = 0;
            
            for (i = 0; i < ships.length; i++) {
            
                nbShipsOrig = nbShipsOrig + ships[i][2];
                nbShipsNew = nbShipsNew + Math.min(getval("transfership"+ships[i][0]), ships[i][2]);
            }
            
            nbShipsOrig = nbShipsOrig - nbShipsNew;
            
            var e_ressource = false;
            var e_ship = false;

            for(i = 0; i < resources.length; i++) {
            
                if (getval("load_" + resources[i]) < 0 || getval("load_" + resources[i]) < 0)
                    {e_ressource = true;break;}
            }

            for (i = 0; i < ships.length; i++) {
            
                if (getval("transfership" + ships[i][0])<0 || getval("transfer" + ships[i][0])<0)
                    {e_ship = true;break;}
            }

            if (e_ressource) {
            
                alert("Quantités de ressources incorrectes.");
                return false;
            }
            else if (e_ship) {
            
                alert("Quantités de vaisseaux incorrectes.");
                return false;
            }
            else if (nbShipsOrig == 0) {
            
                alert("La flotte {fleetname} ne peut contenir zéro vaisseau.");
                return false;
            }
            else if (nbShipsNew == 0) {
            
                alert("La nouvelle flotte ne peut contenir zéro vaisseau.");
                return false;
            }
            else return true;
        }
    </script>
    <div class="scroll-content pe-1" style="height:calc(100% - 44px);">
    <form method="post"
          action="?id={{ fleetid }}"
          onsubmit="return submitchanges()"
          class="card">
        <div class="card-header">
            <div class="row gx-3">
                <div class="col-auto">
                    <a href="/s03/fleet-view/?id={{ fleetid }}"><i class="fa-fw fas fa-arrow-circle-left"></i></a>
                </div>
                <div class="col">Diviser la flotte</div>
                <div class="col-auto">
                    <small class="text-normal">flotte</small>
                </div>
                <div class="col-auto">
                    <span class="text-player">{{ fleetname }}</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-1 flex-column">
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Transfert de vaisseaux</span>
                        </div>
                        <div class="col-2">
                            <span class="text-normal">Cargo</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;">
                            <span class="text-normal">Quantité</span>
                        </div>
                        <div class="col-2">
                            <span class="text-normal">Transférer</span>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr class="my-1">
                </div>
                {% for ship in ships %}
                    <script>ships.push(new Array({{ship.id}}, {{ship.cargo_capacity}}, {{ship.quantity}}));</script>
                    <div class="col-12">
                        <div class="row gx-3 align-items-center">
                            <div class="col">
                                <span class="text-normal">{{ ship.name }}</span>
                            </div>
                            <div class="col-2">{{ ship.cargo_capacity|intcomma }}</div>
                            <div class="col-auto text-end" style="width:75px;">{{ ship.quantity|intcomma }}</div>
                            <div class="col-2">
                                <input type="number"
                                       min="0"
                                       name="transfership{{ ship.id }}"
                                       value="{{ ship.transfer }}"
                                       size="8"/>
                                <a href="javascript:setval('transfership{{ ship.id }}', {{ ship.quantity }})">max</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col-3">
                            <span class="text-normal">Capacité</span> <span class="ms-2 text-player">{{ fleetname }}</span>
                        </div>
                        <div class="col">
                            <span id="capacityOrig">{{ fleet_capacity|intcomma }}</span> <small class="text-normal">unités</small>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col-3">
                            <span class="text-normal">Capacité</span> <span class="ms-2">Nouvelle flotte</span>
                        </div>
                        <div class="col">
                            <span id="capacityNew">0</span> <small class="text-normal">unités</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Transfert de ressources</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;">
                            <span class="text-normal">En soute</span>
                        </div>
                        <div class="col-2">
                            <span class="text-normal">Transférer</span>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr class="my-1">
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Minerai</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;" name="orig_ore">
                            {{ available_ore|intcomma }}
                        </div>
                        <div class="col-2">
                            <input type="number" min="0" name="load_ore" value="{{ t_ore }}" size="8" />
                            <a href="javascript:setmaximum('ore', {{ available_ore }})">max</a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Hydrocarbure</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;" name="orig_hydrocarbon">
                            {{ available_hydrocarbon|intcomma }}
                        </div>
                        <div class="col-2">
                            <input type="number"
                                   min="0"
                                   name="load_hydrocarbon"
                                   value="{{ t_hydrocarbon }}"
                                   size="8"/>
                            <a href="javascript:setmaximum('hydrocarbon', {{ available_hydrocarbon }})">max</a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Scientifique</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;" name="orig_scientists">
                            {{ available_scientists|intcomma }}
                        </div>
                        <div class="col-2">
                            <input type="number"
                                   min="0"
                                   name="load_scientists"
                                   value="{{ t_scientists }}"
                                   size="8"/>
                            <a href="javascript:setmaximum('scientists', {{ available_scientists }})">max</a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Soldat</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;" name="orig_soldiers">
                            {{ available_soldiers|intcomma }}
                        </div>
                        <div class="col-2">
                            <input type="number"
                                   min="0"
                                   name="load_soldiers"
                                   value="{{ t_soldiers }}"
                                   size="8"/>
                            <a href="javascript:setmaximum('soldiers', {{ available_soldiers }})">max</a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col">
                            <span class="text-normal">Travailleur</span>
                        </div>
                        <div class="col-auto text-end" style="width:75px;" name="orig_workers">
                            {{ available_workers|intcomma }}
                        </div>
                        <div class="col-2">
                            <input type="number"
                                   min="0"
                                   name="load_workers"
                                   value="{{ t_workers }}"
                                   size="8"/>
                            <a href="javascript:setmaximum('workers', {{ available_workers }})">max</a>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col-3">
                            <span class="text-normal">Cargaison</span> <span class="ms-2 text-player">{{ fleetname }}</span>
                        </div>
                        <div class="col">
                            <span id="loadOrig">{{ fleet_load }}</span> <small class="text-normal">/<span id="capacityOrig2">{{ fleet_capacity }}</span> unités</small>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row gx-3 align-items-center">
                        <div class="col-3">
                            <span class="text-normal">Cargaison</span> <span class="ms-2">Nouvelle flotte</span>
                        </div>
                        <div class="col">
                            <span id="loadNew">0</span> <small class="text-normal">/<span id="capacityNew2">0</span> unités</small>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <hr>
                </div>
                <div class="col-12">
                    <div class="row gx-2 align-items-center justify-content-end">
                        <div class="col-auto">
                            <span class="text-normal">Nom de la nouvelle flotte</span>
                        </div>
                        <div class="col-auto">
                            <input type="text" name="newname" value="" maxlength="16" />
                        </div>
                        <div class="col-auto">
                            <input type="submit" value="Diviser" />
                        </div>
                    </div>
                </div>
                {% if error3 %}
                    <div class="col-12 text-end">
                        <span class="text-danger">La flotte est occupée. Vous ne pouvez diviser une flotte qui combat, ni récolte ou voyage.</span>
                    </div>
                {% endif %}
                {% if error1 %}
                    <div class="col-12 text-end">
                        <span class="text-danger">Le nom de la flotte est invalide, il ne peut contenir que des lettres (a-z) et des chiffres (0-9).</span>
                    </div>
                {% endif %}
            </div>
        </div>
        <input type="hidden" name="split" value="1" />
        {% csrf_token %}
    </form>
    </div>
    <script>window.setTimeout("updatecargo()", 200);</script>
    <script>window.setTimeout("updateresources()", 200);</script>
{% endblock content %}
