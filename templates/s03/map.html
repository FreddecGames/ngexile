{% extends "s03/layout.html" %}
{% load l10n %}
{% load humanize %}
{% block content %}
    <script>
var currGalaxy="";
var currSector="";

function setLocGalaxy(g){ $("locgalaxy").value=g; }
function setLocSector(s){ $("locsector").value=s; }
function setLoc(g,s) { currGalaxy = g; currSector = s; setLocGalaxy(g); setLocSector(s); }

function openGalaxy(g){	window.location="?g="+g; }
function openSector(g,s){ window.location="?g="+g+"&s="+s; }

{% if nav_universe %}

function displayUniverse(u) {
	var s = "";

	for(var i=1; i<u.length; i++) {
		var g = u[i];

		var c = "";
		if(g[1]) c = "hasplanets";
		else
		if(g[2]) c = "hasallies";
		else
		if(g[3]) c = "hasfriends";
		else
		if(g[4]) c = "hasenemies";
		else
			c = "hasnothing";

		s += '<div class="gal"><div onmouseover="setLocGalaxy('+g[0]+')" onclick="openGalaxy('+g[0]+')"><img src="{{PATH_IMAGES}}galaxies/01.jpg" title="'+g[0]+'" class="'+c+'"></div><div class=galtext>'+g[0]+'</div></div>';
	}

	$('mapuniverseview').innerHTML = s;

	var obj = $('mapuniverse');
	obj.style.display = 'block';
	obj.style.visibility = 'visible';
}
{% endif %}

{% if nav_galaxy %}

var blinklist = new Array();

function getCssRule(name){
	for(var i=0; i<document.styleSheets.length; i++) {

		var theRules = new Array();
		if(document.styleSheets[i].cssRules)
			theRules = document.styleSheets[i].cssRules;
		else 
		if(document.styleSheets[i].rules)
			theRules = document.styleSheets[i].rules;
		else
			return null;

		for(var j=0; j<theRules.length; j++) 
			if(theRules[j].selectorText && theRules[j].selectorText.toLowerCase() == '#mapgalaxyview div.sector div.'+name)
				return theRules[j];
	}

	return null;
}

var isFF = navigator.userAgent.indexOf("Firefox") != -1;
function stopblink(name) {
	if(isFF) {
		for(var x in blinklistFF[name]) {
			rule = $(blinklistFF[name][x]);
			if(rule) rule.style.display = "block";
		}

		CurrentBlink = false;
	}
	else {
		var rule = blinklist[name];
		if(rule) rule.style.visibility = "visible";
		blinklist[name] = null;	
	}
	

}
function startblink(name) {
	if(isFF)
		CurrentBlink = name;
	else
		blinklist[name] = getCssRule(name);
}

if(isFF){ 
	var CurrentBlink = false; 
	var blinklistFF = new Array();
}

function doblinkFF() {
	if(CurrentBlink){
		for(var x in blinklistFF[CurrentBlink]) {
			//alert('blink:'+x);
			rule = $(blinklistFF[CurrentBlink][x]);
			if(rule) rule.style.display = (rule.style.display=="block")?"none":"block";
		}
	}

	window.setTimeout("doblinkFF()", 1000);
}

function doblink() {
	for(var x in blinklist)	{
		rule = blinklist[x];
		if(rule) rule.style.visibility = (rule.style.visibility=="visible")?"hidden":"visible";
	}

	window.setTimeout("doblink()", 1000);
}

if(isFF)
	window.setTimeout("doblinkFF()", 1000);
else
	window.setTimeout("doblink()", 1000);



var pl=new Array();
pl['0']='hostile';
pl['1']='uninhabited';
pl['2']='friend';
pl['3']='ally';
pl['4']='player';
pl['5']='resource';
pl['6']='resource';
pl['7']='vortex';
pl['8']='nothing';

function displayGalaxy(galaxy, m, open, ore, hydro, sov_tag_1, sov_perc_1, sov_tag_2, sov_perc_2, sov_tag_3, sov_perc_3) {
	var res = "";

	var pos = 0;
	for(var i=1; i<100; i++)
	{
		var s = '<div class="sector" onmouseover="setLocSector('+i+')" onclick="openSector('+galaxy+','+i+')">';

		for(var j=0; j<25; j++){
			c = pl[m.charAt(pos)];
			s += '<div class="p'+j+' '+c+'" id="'+i+'-'+j+'"></div>';
			pos++;

			if(isFF) {
				if(!blinklistFF[c]) blinklistFF[c] = new Array();
				blinklistFF[c].push(i+'-'+j);
			}
		}

		s += '</div>';

		res += s;
	}

	$('mapgalaxyview').innerHTML = res;
}
{% endif %}

{% if nav_sector %}
function get_left(obj) {
	var left = obj.offsetLeft;
	while((obj = obj.offsetParent) != null){ left += obj.offsetLeft; }
	return left;
}

function get_top(obj) {
	var top = obj.offsetTop;
	while((obj = obj.offsetParent) != null){ top += obj.offsetTop; }
	return top;
}

function showmenu(objet,title,txt) {	
	var hint = $("hint");
	var hinttext = $("hinttext");
	hint.style.visibility = "hidden";

	var obj = $(objet);
	var max = $("map").offsetWidth + get_left($("map"));
	var x = (get_left(obj)+16);
	var y = (get_top(obj)-$("page").scrollTop);

	hinttext.innerHTML = "<h6>" + title + "</h6>" + txt;

	if (x + hint.offsetWidth > max) {
		x = x - hint.offsetWidth-16;
	}
	
	hint.style.left = x + 'px';
	hint.style.top = y + 'px';
	hint.style.visibility = "visible";
}

function hidemenu() {
	var menu = $("hint");
	menu.style.visibility = "hidden";
	menu.style.left = 0;
	menu.style.top = 0;
}

document.onclick=hidemenu;


function getRelationClass(rel) {
	switch(rel){
		case 2: return "self"; break;
		case 1: return "ally"; break;
		case 0:	return "friend"; break;
		case -1: return "enemy"; break;
		case -2: return "enemy"; break;
		case -3: return "neutral"; break;
	}
	return "";
}


function Fl(id,name,tag,owner,rel,signature,fleeing) {
	if(rel==2 || id != 0)
		var s= '<a title="Inspecter la flotte '+name+'" href="/s03/fleet/?id=' + id + '" class="self">'+(tag!=''?'['+tag+'] ':'')+name+'</a>';
	else
	{
		var c = getRelationClass(rel);

		var s = '<a title="Écrire à '+owner+'" href="/s03/mails/?subject=À propos de la flotte '+name+'&to='+owner+'" class="' + c+ '">' +(tag!=''?'['+tag+'] ':'')+name+'</a>';
	}

	if(signature > 0)
		s += ' ('+formatnumber(signature)+')';
	else
		s += ' (indéterminé)';

	if(fleeing)	s += ' en fuite';
	return s+'<br/>';
}

function descOrbit(idx,planetid,rel,parked) {
	var s="";
	var orbit=orb[idx];

	for(var i=1; i<orbit.length; i++)
		s += Fl(orbit[i][0], orbit[i][1], orbit[i][2], orbit[i][3], orbit[i][4], orbit[i][5], orbit[i][6]);

	if(parked > 0) {
		if(rel == 2)
			s += '<a href="/s03/orbit/?planet='+planetid+'" class="' + getRelationClass(rel) + '">Au sol: ' + formatnumber(parked) + '</a>';
		else
			s += '<span class="' + getRelationClass(rel) + '">Au sol: ' + formatnumber(parked) + '</span>';
	}

	return s;
}

function descSpecials(idx) {
	var s="";
	var elements=elem[idx];

	for(var i=1; i<elements.length; i++)
		s += elements[i] + "<br/>";

	return s;
}

var elem=new Array();
var orb=new Array();
var idx=1;

function loc(img,alliancetag,id,owner,name,rel,radar,jammer,ore,hydrocarbon,floor,space,a_ore,a_hydrocarbon,vortex_strength,frozen,parked,orbit,elements,b_ore,b_hydrocarbon) {
	var c = getRelationClass(rel);

	s = '<div class="col-auto" style="width:20%;">'+
		'<table border="0" cellspacing="0" cellpadding="0" width="140">'+
		'<tr>'+

		'<td align=right width="38">';
		if(ore!='0' || hydrocarbon!='0')
		{
			s+= '<a href="#" class="none" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'resources.'+idx+'\',\'Ressources\',\'Minerai: '+ore+'<br>Hydrocarbure: '+hydrocarbon+'\')">'+
				'<img id="resources.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/resource.gif">'+
				'</a>';
		}
		else
			s+= '<img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif">';

		s+= '</td>';

		s+=	'<td align=center rowspan=4 width="64">'+
			'<div><img class="planet" src="{{PATH_IMAGES}}planets/p'+img+'.gif" width=64 height=64></div><div class=planettext>'+idx+'</div>'+
			'</td>';

		s+= '<td width="38">';

		if(floor!='' || space!='')
		{
			s+= '<a href="#" class=none onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'planet.'+idx+'\',\'Planète\',\'Terrain: '+floor+'<br>Espace: '+space+'<br>Abondance minerai: '+a_ore+'%<br>Abondance hydrocarbure: '+a_hydrocarbon+'%' + (vortex_strength>0?('<br>Stabilité vortex:' + vortex_strength):'') + '\')">'+
				'<img id="planet.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/info.gif">'+
				'</a>';
		}
		else
		if(vortex_strength!='0')
		{
			s+= '<a href="#" class=none onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'planet.'+idx+'\',\'Vortex\',\'Stabilité vortex:' + vortex_strength + '\')">'+
				'<img id="planet.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/info.gif">'+
				'</a>';
		}
		else
			s+= '<img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif">';

		s+= '</td></tr>';


		s+= '<tr>'+
			'<td align=right><img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif"></td>'+
			'<td align=left>';
		if(radar>0 || jammer!=0)
		{
			if(jammer==-1)
			{
				s+= '<a href="#" class="none" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'radar.'+idx+'\',\'Radar brouillé\',\'\')">'+
					'<img id="radar.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/radarjammed.gif">';
			} else
			if(radar>0 && jammer==0)
			{
				s+= '<a href="#" class="none" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'radar.'+idx+'\',\'Radar détecté\',\'Puissance: '+radar+'\')">'+
					'<img id="radar.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/radar.gif">';
			} else
			if(jammer>0)
			{
				s+= '<a href="#" class="none" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'radar.'+idx+'\',\'Radar brouillé détecté\',\'Puissance radar: '+radar+'<br/>Brouillage: '+jammer+'\')">'+
					'<img id="radar.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/radarjammed-known.gif">';
			}
					
			s+= '</a>';
		}
		else
			s+= '<img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif">';
		s+= '</td></tr>';

		s+= '<tr>';

		s+= '<td align=right>';
		if(frozen)
			s+= '<a href="#" class="none" title="En vacances"><img width=16 height=16 src="{{PATH_IMAGES}}map/sector/sleeping.gif"></a>';
		else
		if(b_ore != '0' || b_hydrocarbon != '0')
			s+= '<a href="#" class="none" title="Prix d\'achat" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'price.'+idx+'\',\'Achat de ressources\',\'' + (b_ore != '0'?'Minerai: ' + b_ore + '<br/>':'') + (b_hydrocarbon != '0'?'Hydrocarbure: ' + b_hydrocarbon + '<br/>':'') + '\')">' +
				'<img id="price.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}interface/credits.gif"></a>';
		else
			s+= '<img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif">';
		s+= '</td>';

		orb[idx] = orbit;

		s+= '<td align=left valign=top>';

		if(parked > 0 || orbit.length > 0)
		{
			var enemyfleets = false;
			for(var k=1; k<orbit.length; k++)
				if(orbit[k][4] < 0)
					enemyfleets = true;

			if(enemyfleets)
				f = "-enemy";
			else if(orbit.length > 0)
				f = "-fleets";
			else
				f = "";

			s+= '<a href="#" class="none" onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'fleets.'+idx+'\',\'Flottes\',descOrbit('+idx+','+id+','+rel+','+parked+'))">'+
				'<img id="fleets.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/orbit'+f+'.gif">'+
				'</a>';
		}
		else
			s+= '<img width=1 height=16 src="{{PATH_IMAGES}}interface/spacer.gif">';

		s+= '</td></tr>';

		s+= '<tr>';

		elem[idx] = elements;

		s+= '<td align="right">';
		if(elements.length > 0)
		{
			s+= '<a href="#" class=none onclick="return donothide(event)" onfocus="this.onmouseover()" onmouseover="showmenu(\'elements.'+idx+'\',\'Spécial\',descSpecials('+idx+'))">'+
				'<img id="elements.'+idx+'" width=16 height=16 src="{{PATH_IMAGES}}map/sector/special.gif">'+
				'</a>';
		}
		else
			s+= '<img width="1" height="16" src="{{PATH_IMAGES}}interface/spacer.gif">';
		s+= '</td>';

		s+= '<td align="left" valign="top"><img width="1" height="16"></td>'+
			'</tr>';

		s+= '<tr><td colspan="3" align="center" class="planetname">';

		var n='';

		if(alliancetag != '') n+='<a href="/s03/alliance/?tag='+alliancetag+'" class="'+c+'">['+alliancetag+']</a>';

		if(rel==2)
		{
			if(floor>0 && space>0)
				n+= '<a href="/s03/planet/?planet='+id+'" class="'+c+'" title="Inspecter la planète '+name+'">'+name+'</a>';
			else
				n+= '<span class="'+c+'">'+name+'</span>';
		}
		else
		if(rel==-3 && isNaN(parseInt(img))) n+= '';
		else
		if(rel==-3) n+= '<span class="grey">inhabitée</span>';
		else
		{
			if(name=='') name=owner;
			if(owner=='')
				n+= '<span class="'+c+'" title="Planète occupée">Occupée</span>';
			else
				n+= '<a href="/s03/nation/?name='+owner+'" class="'+c+'" title="Voir les informations sur '+owner+'">'+name+'</a>';
		}

		if(n=='') n = '&nbsp;';

		s += n;

		s+= '</td></tr>'+
			'</table>'+
		'</div>';

	idx++;

	return s;
}

function displaySector(arr) {
	idx = 1;

	var html = "";
	for(var i=1; i<arr.length; i++) {
		var p = arr[i];
		html += loc(p[0], p[1], p[2], p[3], p[4], p[5], p[6], p[7], p[8], p[9], p[10], p[11], p[12], p[13], p[14], p[15], p[16], p[17], p[18], p[19], p[20]);
	}

	$('mapSector').innerHTML = html
}

function r(rel,tag,owner,fleetid,fleet,sig,f_id,f_name,f_g,f_s,f_p,f_rel,t_id,t_name,t_g,t_s,t_p,t_rel,time,losing) {
	var c = getRelationClass(rel);

	var s = '<tr class="smallitem"><td>';
	if(tag != '') s+= '<a href="/s03/alliance/?tag='+tag+'" class='+c+'>['+tag+']</a> ';
	s+= '<a href="/s03/nation/?name='+owner+'" title="Voir les informations sur '+owner+'" class="'+c+'">'+owner+'</a></td><td>';
	if(rel==2)
		s+= '<a href="/s03/fleet/?id='+fleetid+'" class="self">'+fleet+'</a>';
	else
		s+= '<a href="/s03/mails/?to='+owner+'" class="'+c+'" title="Envoyer un message à '+owner+'">'+fleet+'</a>';

	if(sig > 0)
		s+= ' ('+formatnumber(sig)+')';
	else
		s+= ' (indéterminé)';
	s+= '</td><td>';

	if(f_id != '')
		s+= planet_str(f_id,f_name,f_g,f_s,f_p,f_rel);
	else
		s+= '<span class="grey">Inconnue</span>';
	
	s+= '</td><td>';
	
	if(t_id != '')
		s+= planet_str(t_id,t_name,t_g,t_s,t_p,t_rel);
	else
		s+= '<span class="grey">Inconnue</span>';

	s+= '</td><td>'
	
	if(losing)
		s+= 'Perte du signal :&nbsp;<script>putcountdown1('+time+', "Signal perdu", "/s03/overview/");</'+'script>';
	else
		s+= '<script>putcountdown1('+time+', "Arrivé", "/s03/overview/");</'+'script>';
		
	s+= '</td></tr>';

	document.write(s);
}

function displayRadar() {
	var obj = $('mapradar');
	obj.style.display = 'block';
	obj.style.visibility = 'visible';
}
{% endif %}
</script>

<div class="mb-3">
   <form method="get" action="?" class="card card-body py-2">
        <div class="row gx-3 align-items-center justify-content-center">
            <div class="col-auto">
                <a href="#" onclick="openGalaxy(''); return false;" data-bs-toggle="tooltip" data-bs-title="Voir l'univers">Univers</a>
            </div>
            <div class="col-auto">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto">
                        {% if galaxy_link %}<a href="#" onclick="openGalaxy(currGalaxy); return false;" data-bs-toggle="tooltip" data-bs-title="Voir la galaxie">Galaxie</a>
                        {% else %}<span class="text-normal">Galaxie</span>{% endif %}
                    </div>
                    <div class="col-auto">
                        <input type="number" class="form-control text-center" name="g" id="locgalaxy" size="2" min="1" maxlength="2" autocomplete="off" value="{{ galaxy }}">
                    </div>
                    <div class="col-auto">
                        <span class="text-normal">Secteur</span>
                    </div>
                    <div class="col-auto">
                        <input type="number" class="form-control text-center" name="s" id="locsector" size="2" min="1" maxlength="2" autocomplete="off" value="{{ sector }}">
                    </div>
                    <div class="col-auto">
                        <input type="submit" class="btn btn-primary" value="Localiser">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% if nav_universe %}
<div class="row gx-1 align-items-center justify-content-center">
    {% for galaxy in galaxies %}
        <div class="col-auto">
            <a href="#" onmouseover="setLocGalaxy({{ galaxy.galaxyid }})" onclick="openGalaxy({{ galaxy.galaxyid }})" data-bs-toggle="tooltip" data-bs-title="Voir la galaxie" class="d-block bg-black rounded border {% if galaxy.hasplanet %}border-info{% elif galaxy.hasally %}border-success{% elif galaxy.hasfriend %}border-success{% elif galaxy.hasenemy %}border-danger{% endif %}">
                <div><img src="{{PATH_IMAGES}}galaxies/01.jpg" width="64px" height="64px" class="rounded"></div>
                <div class="text-center"><span>{{ galaxy.galaxyid }}</span></div>
            </a>
        </div>
    {% endfor %}
</div>
{% elif nav_galaxy %}
<div class="mb-3">
    <div class="row gx-3 align-items-center">
        <div class="col-4">
            <div class="card card-body py-2">
                <div class="row g-1 flex-column">
                    <div class="col-12 text-center"><span class="fs-6">Marché</span></div>
                    <div class="col-12">
                        <div class="row gx-3 align-items-center justify-content-center">
                            <div class="col-auto">
                                <small class="text-normal me-2">Minerai</small>
                                <img src="{{ PATH_IMAGES }}interface/credits.gif" data-bs-toggle="tooltip" data-bs-title="Crédits" class="res" width="16" height="16">
                                <span>{{ price_ore }}</span>
                            </div>
                            <div class="col-auto">
                                <small class="text-normal me-2">Hydrocarbure</small>
                                <img src="{{ PATH_IMAGES }}interface/credits.gif" data-bs-toggle="tooltip" data-bs-title="Crédits" class="res" width="16" height="16">
                                <span>{{ price_hydrocarbon }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card card-body py-2">
                <div class="row g-1 flex-column">
                    <div class="col-12 text-center"><span class="fs-6">Souveraineté</span></div>
                    <div class="col-12">
                        <div class="row gx-3 align-items-center justify-content-center">
                            {% if not sov_tag_1 %}
                            <div class="col-auto">
                                <span class="text-normal">Aucune alliance n'a la souveraineté</span>
                            </div>
                            {% else %}
                            <div class="col-auto">
                                <a href="/s03/alliance/?tag={{ sov_tag_1 }}" data-bs-toggle="tooltip" data-bs-title="Voir l'alliance">[{{ sov_tag_1 }}]</a>
                                <span class="ms-1">{{ sov_perc_1 }}%</span>
                            </div>
                            {% endif %}
                            {% if sov_tag_2 %}
                            <div class="col-auto">
                                <a href="/s03/alliance/?tag={{ sov_tag_2 }}" data-bs-toggle="tooltip" data-bs-title="Voir l'alliance">[{{ sov_tag_2 }}]</a>
                                <span class="ms-1">{{ sov_perc_2 }}%</span>
                            </div>
                            {% endif %}
                            {% if sov_tag_3 %}
                            <div class="col-auto">
                                <a href="/s03/alliance/?tag={{ sov_tag_3 }}" data-bs-toggle="tooltip" data-bs-title="Voir l'alliance">[{{ sov_tag_3 }}]</a>
                                <span class="ms-1">{{ sov_perc_3 }}%</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card card-body py-2">
                <div class="row g-1 flex-column">
                    <div class="col-12 text-center"><span class="fs-6">Ouverture</span></div>
                    <div class="col-12 text-center">
                        {% if protected_until > 0 %}<script>document.write(formattime({{ protected_until }}))</script>
                        {% else %}<span class="text-success">Ouverte au saut</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function displayGalaxy(id, data) {
    
        var html = "";

        var pos = 0;
        for (var i = 1; i < 100; i++) {
            
            var s = ''
            s += '<div class="col-auto" style="width:10%; padding:1px;">'
                s += '<a href="#" class="d-block bg-black rounded p-1" onmouseover="setLocSector(' + i + ')" onclick="openSector(' + id + ',' + i + ')" data-bs-toggle="tooltip" data-bs-title="Secteur ' + i + '" >';
                    s += '<div class="row g-0 align-items-center justify-content-center">'

                        for (var j = 0; j < 25; j++) {
                        
                            c = pl[data.charAt(pos)];
                            
                            let classname = ''
                            if (c == 'nothing') classname = 'text-black'
                            else if (c == 'uninhabited') classname = 'text-muted'
                            else if (c == 'hostile') classname = 'text-danger'
                            else if (c == 'resource') classname = 'text-yellow'
                            else if (c == 'vortex') classname = 'text-purple'
                            else if (c == 'friend') classname = 'text-dark-success'
                            else if (c == 'ally') classname = 'text-success'
                            else if (c == 'player') classname = 'text-info'
                            else console.log(c)
                            
                            s += '<div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="width:20%; padding:3px;">'
                                s += '<i class="fa-fw fas fa-circle ' + classname + '" style="font-size:3px;"></i>'
                            s += '</div>';
                                                        
                            pos++;
                        }

                    s += '</div>';
                s += '</a>';
            s += '</div>';

            html += s;
        }

        $('mapGalaxy').innerHTML = html;
    }
</script>
<div class="mb-3 d-flex align-items-center justify-content-center">
    <div class="card card-body p-1" style="max-width:560px;">
        <div id="mapGalaxy" class="row g-0"></div>
        <script>displayGalaxy({{ galaxy }}, '{{ mapgalaxy }}');</script>
    </div>
</div>
<div class="d-flex align-items-center justify-content-center">
    <div class="card card-body py-2" style="max-width:560px;">
        <div class="row gx-3">
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-black" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-black">Système vide</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-muted" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-muted">Planète inhabitée</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-danger" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-danger">Planète hostile</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-yellow" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-yellow">Ressources</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-dark-success" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-dark-success">Planète en PNA</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-success" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-success">Planète alliée</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-info" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-info">Planète controlée</span></div>
                </div>
            </div>
            <div class="col-3">
                <div class="row gx-2 align-items-center">
                    <div class="col-auto lh-1 d-flex align-items-center justify-content-center" style="padding:3px;">
                        <i class="fa-fw fas fa-circle text-purple" style="font-size:3px;"></i>
                    </div>
                    <div class="col-auto"><span class="text-purple">Vortex</span></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif nav_sector %}
<div class="mb-3 d-flex align-items-center justify-content-center">
    <div class="bg-black border rounded">
        <table cellspacing="0" border="0">
            <tr>
                <td><a href="#" onclick="openSector({{ galaxy }},{{ sector0 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector0 }}"><i class="fa-fw fas fa-chevron-up" style="transform:rotate(-45deg);"></i></a></td>
                <td align="center"><a href="#" onclick="openSector({{ galaxy }},{{ sector1 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector1 }}"><i class="fa-fw fas fa-chevron-up"></i></a></td>
                <td><a href="#" onclick="openSector({{ galaxy }},{{ sector2 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector2 }}"><i class="fa-fw fas fa-chevron-up" style="transform:rotate(45deg);"></i></a></td>
            </tr>
            <tr>
                <td valign="middle"><a href="#" onclick="openSector({{ galaxy }},{{ sector7 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector7 }}"><i class="fa-fw fas fa-chevron-left"></i></a></td>
                <td>
                    <div id="mapSector" class="row g-0" style="width:720px;"></div>
                    <script>
                        displaySector(new Array(0
                            {% for planet in locations %},new Array('{% if planet.planet %}{{planet.planet_img}}{% endif %}{% if planet.vortex %}vortex{% endif %}{% if planet.asteroids %}asteroids{% endif %}{% if planet.clouds %}clouds{% endif %}', '{{planet.alliancetag}}','{{planet.planetid}}','{{planet.ownername}}','{{planet.planetname}}',{{planet.relation}},{{planet.radarstrength}},{{planet.radarjamming}},'{{planet.ore|intcomma}}','{{planet.hydrocarbon|intcomma}}','{{planet.floor}}','{{planet.space}}', '{{planet.a_ore}}','{{planet.a_hydrocarbon}}','{{planet.vortex_strength}}',{% if planet.frozen %}true{% endif %}{% if planet.active %}false{% endif %},{{planet.parked}}
                            ,new Array({% if planet.orbit %}0{% for fleet in planet.fleets %},new Array({{fleet.fleetid}},'{{fleet.fleetname}}','{{fleet.alliancetag}}','{{fleet.fleetowner}}',{{fleet.relation}},{{fleet.signature}},0{% if fleet.fleeing %}1{% endif %}){% endfor %}{% endif %})
                            ,new Array({% if planet.elements %}0{% for element in planet.elements %},'{{element.element}}'{% endfor %}{% endif %})
                            ,'{{planet.buy_ore|intcomma}}','{{planet.buy_hydrocarbon|intcomma}}'
                            ){% endfor %}
                        ));                            
                    </script>
                </td>
                <td valign="middle"><a href="#" onclick="openSector({{ galaxy }},{{ sector3 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector3 }}"><i class="fa-fw fas fa-chevron-right"></i></a></td>
            </tr>
            <tr>
                <td><a href="#" onclick="openSector({{ galaxy }},{{ sector6 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector6 }}"><i class="fa-fw fas fa-chevron-down" style="transform:rotate(45deg);"></i></a></td>
                <td align="center"><a href="#" onclick="openSector({{ galaxy }},{{ sector5 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector5 }}"><i class="fa-fw fas fa-chevron-down"></i></a></td>
                <td><a href="#" onclick="openSector({{ galaxy }},{{ sector4 }})" data-bs-toggle="tooltip" data-bs-title="Secteur {{ sector4 }}"><i class="fa-fw fas fa-chevron-down" style="transform:rotate(-45deg);"></i></a></td>
            </tr>
        </table>
    </div>
</div>
{% endif %}

<div id="map">
<p align="center">
<table>
{% if radar %}
<tr>
<td colspan="2">
<div id="mapradar">
<table class="default" width="100%">
<tr class="title">
<td colspan="5">
Activité Radar
</td>
</tr>
<tr class="header">
<td>
Nation
</td>
<td>
Flotte
</td>
<td>
Origine
</td>
<td>
Destination
</td>
<td>
Temps restant
</td>
</tr>
{% if moving %}
<tr class="category">
<td colspan="5">
Mouvements des flottes
</td>
</tr>
{% for fleet in movings %}
<script>
	    r({{fleet.relation}},"{{fleet.alliancetag}}","{{fleet.name}}","{{fleet.fleetid}}","{{fleet.fleetname}}",{{fleet.signature}},"{{fleet.f_planetid}}","{{fleet.f_planetname}}","{{fleet.f_g}}","{{fleet.f_s}}","{{fleet.f_p}}",{{fleet.f_relation}},"{{fleet.t_planetid}}","{{fleet.t_planetname}}","{{fleet.t_g}}","{{fleet.t_s}}","{{fleet.t_p}}",{{fleet.t_relation}},{{fleet.time}}, {% if fleet.losing %}true{% endif %}{% if fleet.timeleft %}false{% endif %});
	
</script>
{% empty %}
<tr class="smallitem">
<td colspan="5" align="center">
Aucun mouvement détecté
</td>
</tr>
{% endfor %}
{% endif %}
{% if entering %}
<tr class="category">
<td colspan="5">
Flottes entrant dans le secteur
</td>
</tr>
{% for fleet in enterings %}
<script>
	    r({{fleet.relation}},"{{fleet.alliancetag}}","{{fleet.name}}","{{fleet.fleetid}}","{{fleet.fleetname}}",{{fleet.signature}},"{{fleet.f_planetid}}","{{fleet.f_planetname}}","{{fleet.f_g}}","{{fleet.f_s}}","{{fleet.f_p}}",{{fleet.f_relation}},"{{fleet.t_planetid}}","{{fleet.t_planetname}}","{{fleet.t_g}}","{{fleet.t_s}}","{{fleet.t_p}}",{{fleet.t_relation}},{{fleet.time}}, {% if fleet.losing %}true{% endif %}{% if fleet.timeleft %}false{% endif %});
	
</script>
{% empty %}
<tr class="smallitem">
<td align="center" colspan="5">
Aucune flotte détectée
</td>
</tr>
{% endfor %}
{% endif %}
{% if leaving %}
<tr class="category">
<td colspan="5">
Flottes sortant du secteur
</td>
</tr>
{% for fleet in leavings %}
<script>
	    r({{fleet.relation}},"{{fleet.alliancetag}}","{{fleet.name}}","{{fleet.fleetid}}","{{fleet.fleetname}}",{{fleet.signature}},"{{fleet.f_planetid}}","{{fleet.f_planetname}}","{{fleet.f_g}}","{{fleet.f_s}}","{{fleet.f_p}}",{{fleet.f_relation}},"{{fleet.t_planetid}}","{{fleet.t_planetname}}","{{fleet.t_g}}","{{fleet.t_s}}","{{fleet.t_p}}",{{fleet.t_relation}},{{fleet.time}}, {% if fleet.losing %}true{% endif %}{% if fleet.timeleft %}false{% endif %});
	
</script>
{% empty %}
<tr class="smallitem">
<td colspan="5" align="center">
Aucune flotte détectée
</td>
</tr>
{% endfor %}
{% endif %}
</table>
</div>
<script>
	displayRadar();
	
</script>
</td>
</tr>
{% endif %}
</table>
</p>
</div>
<script>
setLoc('{{galaxy}}','{{sector}}');
</script>
{% endblock %}
